# Authentik Blueprint: GitHub OAuth Source
# Optional GitHub OAuth for social login (only enabled when GITHUB_CLIENT_ID is set)
version: 1
metadata:
  name: GitHub OAuth Source
  labels:
    blueprints.goauthentik.io/instantiate: "true"

context:
  github_client_id: !Env [GITHUB_CLIENT_ID, ""]

entries:
  # GitHub OAuth Source
  - model: authentik_sources_oauth.oauthsource
    id: github-oauth-source
    identifiers:
      slug: github
    attrs:
      name: GitHub
      slug: github
      enabled: !If [!Context github_client_id, true, false]
      authentication_flow: !Find [authentik_flows.flow, [slug, madewithprisme-authentication]]
      enrollment_flow: !Find [authentik_flows.flow, [slug, madewithprisme-enrollment]]
      user_matching_mode: email_link
      provider_type: github
      consumer_key: !Env [GITHUB_CLIENT_ID, ""]
      consumer_secret: !Env [GITHUB_CLIENT_SECRET, ""]
      additional_scopes: "read:user user:email"

  # Update identification stage to include GitHub source (when configured)
  - model: authentik_stages_identification.identificationstage
    id: authentication-identification-with-github
    identifiers:
      name: madewithprisme-authentication-identification
    attrs:
      name: madewithprisme-authentication-identification
      user_fields:
        - email
        - username
      show_source_labels: true
      show_matched_user: true
      enrollment_flow: !Find [authentik_flows.flow, [slug, madewithprisme-enrollment]]
      recovery_flow: !Find [authentik_flows.flow, [slug, madewithprisme-recovery]]
      password_stage: !Find [authentik_stages_password.passwordstage, [name, madewithprisme-authentication-password]]
      sources:
        - !Find [authentik_sources_oauth.oauthsource, [slug, github]]
    conditions:
      - !If [!Context github_client_id, true, false]
