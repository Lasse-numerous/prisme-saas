# Authentik Blueprint for TOTP MFA
# Adds optional TOTP (authenticator app) MFA for users
version: 1
metadata:
  name: TOTP MFA Setup
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # TOTP Authenticator Setup Stage (for users to enroll in settings)
  - model: authentik_stages_authenticator_totp.authenticatortotpstage
    id: totp-setup-stage
    identifiers:
      name: totp-setup
    attrs:
      friendly_name: "Authenticator App"
      digits: 6

  # TOTP Validation Stage (for login)
  - model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    id: totp-validation-stage
    identifiers:
      name: totp-validation
    attrs:
      device_classes:
        - totp
      # Skip if user hasn't set up TOTP (optional MFA)
      # Change to "deny" to make MFA mandatory
      not_configured_action: skip

  # Add TOTP validation to default authentication flow (after password stage)
  - model: authentik_flows.flowstagebinding
    id: totp-auth-binding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, default-authentication-flow]]
      stage: !Find [authentik_stages_authenticator_validate.authenticatorvalidatestage, [name, totp-validation]]
    attrs:
      order: 30  # After password (typically order 20)

  # Add TOTP setup to user settings flow
  - model: authentik_flows.flowstagebinding
    id: totp-settings-binding
    identifiers:
      target: !Find [authentik_flows.flow, [slug, default-user-settings-flow]]
      stage: !Find [authentik_stages_authenticator_totp.authenticatortotpstage, [name, totp-setup]]
    attrs:
      order: 10
