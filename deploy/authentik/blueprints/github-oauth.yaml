# Authentik Blueprint for GitHub OAuth Sign-In
# This is applied idempotently on Authentik startup
version: 1
metadata:
  name: GitHub OAuth Source
  labels:
    blueprints.goauthentik.io/instantiate: "true"

entries:
  # GitHub OAuth Source
  - model: authentik_sources_oauth.oauthsource
    id: github-oauth-source
    identifiers:
      slug: github
    attrs:
      name: GitHub
      slug: github
      enabled: true
      authentication_flow: !Find [authentik_flows.flow, [slug, default-source-authentication]]
      enrollment_flow: !Find [authentik_flows.flow, [slug, default-source-enrollment]]
      user_matching_mode: email_link
      provider_type: github
      consumer_key: !Env [GITHUB_CLIENT_ID, ""]
      consumer_secret: !Env [GITHUB_CLIENT_SECRET, ""]
      # Request user:email scope for email access
      additional_scopes: "read:user user:email"
    conditions:
      - !Condition
        conditions:
          - !Env [GITHUB_CLIENT_ID, ""]
        match: "!="
        value: ""

  # Add GitHub to identification stage (login page)
  - model: authentik_stages_identification.identificationstage
    id: default-identification-stage
    identifiers:
      name: default-authentication-identification
    attrs:
      user_fields:
        - email
        - username
      sources:
        - !Find [authentik_sources_oauth.oauthsource, [slug, github]]
    conditions:
      - !Condition
        conditions:
          - !Env [GITHUB_CLIENT_ID, ""]
        match: "!="
        value: ""
