# Authentik Authentication Stack
#
# AUTO-GENERATED BY PRISM - DO NOT EDIT
# Docker Compose stack for Authentik identity provider with Traefik reverse proxy.
#
# Usage:
#   1. Copy .env.authentik.example to .env.authentik and fill in values
#   2. Run: docker compose -f docker-compose.authentik.yml up -d
#
# Services:
#   - traefik: Reverse proxy with automatic SSL (Let's Encrypt)
#   - authentik-server: Authentik web interface and API
#   - authentik-worker: Background task processor
#   - authentik-db: PostgreSQL database for Authentik
#   - authentik-redis: Redis for caching and task queue

services:
  authentik-server:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_VERSION:-2024.2}
    container_name: madewithprisme-authentik-server
    restart: unless-stopped
    command: server
    environment:
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_DB_USER:-authentik}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_DB_NAME:-authentik}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_EMAIL__HOST=${SMTP_HOST}
      - AUTHENTIK_EMAIL__PORT=${SMTP_PORT:-587}
      - AUTHENTIK_EMAIL__USERNAME=${SMTP_USERNAME}
      - AUTHENTIK_EMAIL__PASSWORD=${SMTP_PASSWORD}
      - AUTHENTIK_EMAIL__USE_TLS=true
      - AUTHENTIK_EMAIL__FROM=${SMTP_FROM}
    volumes:
      - authentik-media:/media
      - authentik-templates:/templates
    depends_on:
      - authentik-db
      - authentik-redis
    networks:
      - madewithprisme-network
    ports:
      - "9000:9000"

  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_VERSION:-2024.2}
    container_name: madewithprisme-authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_DB_USER:-authentik}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_DB_NAME:-authentik}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
    volumes:
      - authentik-media:/media
      - authentik-certs:/certs
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - authentik-db
      - authentik-redis
    networks:
      - madewithprisme-network

  authentik-db:
    image: postgres:16-alpine
    container_name: madewithprisme-authentik-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${AUTHENTIK_DB_USER:-authentik}
      - POSTGRES_PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - POSTGRES_DB=${AUTHENTIK_DB_NAME:-authentik}
    volumes:
      - authentik-db-data:/var/lib/postgresql/data
    networks:
      - madewithprisme-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTHENTIK_DB_USER:-authentik}"]
      interval: 10s
      timeout: 5s
      retries: 5

  authentik-redis:
    image: redis:7-alpine
    container_name: madewithprisme-authentik-redis
    restart: unless-stopped
    command: --save 60 1 --loglevel warning
    volumes:
      - authentik-redis-data:/data
    networks:
      - madewithprisme-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  authentik-db-data:
  authentik-redis-data:
  authentik-media:
  authentik-templates:
  authentik-certs:

networks:
  madewithprisme-network:
    name: madewithprisme-network
