"""API integration tests for Subdomain.

⚠️ AUTO-GENERATED BY PRISM - DO NOT EDIT
"""

from __future__ import annotations

import pytest
from tests.factories.subdomain import SubdomainFactory


class TestSubdomainAPI:
    """API integration tests for Subdomain endpoints."""

    @pytest.mark.asyncio
    async def test_list_subdomains(self, client, db):
        """Test GET /subdomains"""
        # Create test data
        SubdomainFactory._meta.sqlalchemy_session = db
        for _ in range(3):
            SubdomainFactory.create()
        await db.commit()

        response = await client.get("/api/subdomains")

        assert response.status_code == 200
        data = response.json()
        assert "items" in data
        assert len(data["items"]) >= 3

    @pytest.mark.asyncio
    async def test_get_subdomain(self, client, db):
        """Test GET /subdomains/{id}"""
        SubdomainFactory._meta.sqlalchemy_session = db
        instance = SubdomainFactory.create()
        await db.commit()

        response = await client.get(f"/api/subdomains/{instance.id}")

        assert response.status_code == 200
        data = response.json()
        assert data["id"] == instance.id

    @pytest.mark.asyncio
    async def test_get_subdomain_not_found(self, client):
        """Test GET /subdomains/{id} with invalid ID"""
        response = await client.get("/api/subdomains/99999")

        assert response.status_code == 404

    @pytest.mark.asyncio
    async def test_claim_subdomain(self, client):
        """Test POST /subdomains/claim"""
        payload = {
            "name": "testclaim",  # Valid subdomain name (no underscores)
        }

        response = await client.post("/api/subdomains/claim", json=payload)

        assert response.status_code == 201
        data = response.json()
        assert "id" in data
        assert data["name"] == "testclaim"
        assert data["status"] == "reserved"

    @pytest.mark.asyncio
    async def test_activate_subdomain(self, client, db):
        """Test POST /subdomains/{name}/activate"""
        SubdomainFactory._meta.sqlalchemy_session = db
        instance = SubdomainFactory.create(status="reserved")
        await db.commit()

        payload = {
            "ip_address": "192.168.1.1",
        }

        response = await client.post(f"/api/subdomains/{instance.name}/activate", json=payload)

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "active"
        assert data["ip_address"] == "192.168.1.1"

    @pytest.mark.asyncio
    async def test_delete_subdomain(self, client, db):
        """Test DELETE /subdomains/{id}"""
        SubdomainFactory._meta.sqlalchemy_session = db
        instance = SubdomainFactory.create()
        await db.commit()

        response = await client.delete(f"/api/subdomains/{instance.id}")

        assert response.status_code == 204
