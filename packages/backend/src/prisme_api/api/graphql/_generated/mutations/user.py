"""GraphQL mutations for User.

⚠️ AUTO-GENERATED BY PRISM - DO NOT EDIT
"""

import re

import strawberry
from strawberry.types import Info

from prisme_api.schemas.user import UserCreate, UserUpdate
from prisme_api.services.user import UserService

from ..context import Context
from ..types.user import UserInput, UserType, UserUpdateInput, user_from_model


def _camel_to_snake(name: str) -> str:
    """Convert camelCase to snake_case."""
    return re.sub(r"(?<!^)(?=[A-Z])", "_", name).lower()


def _convert_keys_to_snake(data: dict) -> dict:
    """Convert all dictionary keys from camelCase to snake_case."""
    return {_camel_to_snake(k): v for k, v in data.items()}


@strawberry.type
class UserMutations:
    """GraphQL mutations for User."""

    @strawberry.mutation(description="Create a new User")
    async def createUser(
        self,
        info: Info[Context, None],
        input: UserInput,
    ) -> UserType:
        """Create a new User."""
        service = UserService(info.context.db)

        # Convert GraphQL input to Pydantic schema (camelCase -> snake_case)
        data = UserCreate(**_convert_keys_to_snake(strawberry.asdict(input)))
        result = await service.create(data=data)

        return user_from_model(result)

    @strawberry.mutation(description="Update an existing User")
    async def updateUser(
        self,
        info: Info[Context, None],
        id: int,
        input: UserUpdateInput,
    ) -> UserType | None:
        """Update a User."""
        service = UserService(info.context.db)

        # Convert GraphQL input to Pydantic schema, excluding None values (camelCase -> snake_case)
        input_dict = {
            _camel_to_snake(k): v for k, v in strawberry.asdict(input).items() if v is not None
        }
        data = UserUpdate(**input_dict)
        result = await service.update(id=id, data=data)

        if result is None:
            return None
        return user_from_model(result)

    @strawberry.mutation(description="Delete a User")
    async def deleteUser(
        self,
        info: Info[Context, None],
        id: int,
    ) -> bool:
        """Delete a User."""
        service = UserService(info.context.db)
        return await service.delete(id=id)

    @strawberry.mutation(description="Create multiple users")
    async def createUsers(
        self,
        info: Info[Context, None],
        input: list[UserInput],
    ) -> list[UserType]:
        """Create multiple users in a single request."""
        service = UserService(info.context.db)

        data = [UserCreate(**_convert_keys_to_snake(strawberry.asdict(item))) for item in input]
        results = await service.create_many(data=data)

        return [user_from_model(item) for item in results]

    @strawberry.mutation(description="Update multiple users")
    async def updateUsers(
        self,
        info: Info[Context, None],
        ids: list[int],
        input: UserUpdateInput,
    ) -> int:
        """Update multiple users with the same data. Returns count updated."""
        service = UserService(info.context.db)

        input_dict = {
            _camel_to_snake(k): v for k, v in strawberry.asdict(input).items() if v is not None
        }
        data = UserUpdate(**input_dict)

        return await service.update_many(ids=ids, data=data)

    @strawberry.mutation(description="Delete multiple users")
    async def deleteUsers(
        self,
        info: Info[Context, None],
        ids: list[int],
    ) -> int:
        """Delete multiple users. Returns count deleted."""
        service = UserService(info.context.db)
        return await service.delete_many(ids=ids)


__all__ = ["UserMutations"]
