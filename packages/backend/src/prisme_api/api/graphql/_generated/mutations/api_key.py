"""GraphQL mutations for APIKey.

⚠️ AUTO-GENERATED BY PRISM - DO NOT EDIT
"""

import re

import strawberry
from strawberry.types import Info

from prisme_api.schemas.api_key import APIKeyCreate, APIKeyUpdate
from prisme_api.services.api_key import APIKeyService

from ..context import Context
from ..types.api_key import APIKeyInput, APIKeyType, APIKeyUpdateInput, api_key_from_model


def _camel_to_snake(name: str) -> str:
    """Convert camelCase to snake_case."""
    return re.sub(r"(?<!^)(?=[A-Z])", "_", name).lower()


def _convert_keys_to_snake(data: dict) -> dict:
    """Convert all dictionary keys from camelCase to snake_case."""
    return {_camel_to_snake(k): v for k, v in data.items()}


@strawberry.type
class APIKeyMutations:
    """GraphQL mutations for APIKey."""

    @strawberry.mutation(description="Create a new APIKey")
    async def createAPIKey(
        self,
        info: Info[Context, None],
        input: APIKeyInput,
    ) -> APIKeyType:
        """Create a new APIKey."""
        service = APIKeyService(info.context.db)

        # Convert GraphQL input to Pydantic schema (camelCase -> snake_case)
        data = APIKeyCreate(**_convert_keys_to_snake(strawberry.asdict(input)))
        result = await service.create(data=data)

        return api_key_from_model(result)

    @strawberry.mutation(description="Update an existing APIKey")
    async def updateAPIKey(
        self,
        info: Info[Context, None],
        id: int,
        input: APIKeyUpdateInput,
    ) -> APIKeyType | None:
        """Update a APIKey."""
        service = APIKeyService(info.context.db)

        # Convert GraphQL input to Pydantic schema, excluding None values (camelCase -> snake_case)
        input_dict = {
            _camel_to_snake(k): v for k, v in strawberry.asdict(input).items() if v is not None
        }
        data = APIKeyUpdate(**input_dict)
        result = await service.update(id=id, data=data)

        if result is None:
            return None
        return api_key_from_model(result)

    @strawberry.mutation(description="Delete a APIKey")
    async def deleteAPIKey(
        self,
        info: Info[Context, None],
        id: int,
    ) -> bool:
        """Delete a APIKey."""
        service = APIKeyService(info.context.db)
        return await service.delete(id=id)

    @strawberry.mutation(description="Create multiple api_keys")
    async def createAPIKeys(
        self,
        info: Info[Context, None],
        input: list[APIKeyInput],
    ) -> list[APIKeyType]:
        """Create multiple api_keys in a single request."""
        service = APIKeyService(info.context.db)

        data = [APIKeyCreate(**_convert_keys_to_snake(strawberry.asdict(item))) for item in input]
        results = await service.create_many(data=data)

        return [api_key_from_model(item) for item in results]

    @strawberry.mutation(description="Update multiple api_keys")
    async def updateAPIKeys(
        self,
        info: Info[Context, None],
        ids: list[int],
        input: APIKeyUpdateInput,
    ) -> int:
        """Update multiple api_keys with the same data. Returns count updated."""
        service = APIKeyService(info.context.db)

        input_dict = {
            _camel_to_snake(k): v for k, v in strawberry.asdict(input).items() if v is not None
        }
        data = APIKeyUpdate(**input_dict)

        return await service.update_many(ids=ids, data=data)

    @strawberry.mutation(description="Delete multiple api_keys")
    async def deleteAPIKeys(
        self,
        info: Info[Context, None],
        ids: list[int],
    ) -> int:
        """Delete multiple api_keys. Returns count deleted."""
        service = APIKeyService(info.context.db)
        return await service.delete_many(ids=ids)


__all__ = ["APIKeyMutations"]
