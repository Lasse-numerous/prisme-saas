"""Authentik OIDC configuration.

⚠️ AUTO-GENERATED BY PRISM - DO NOT EDIT
Configuration settings for Authentik OIDC integration.
"""

from __future__ import annotations

import os
from functools import lru_cache

from pydantic_settings import BaseSettings


class AuthentikSettings(BaseSettings):
    """Authentik OIDC settings loaded from environment variables."""

    # OIDC Configuration
    client_id: str = os.getenv("AUTHENTIK_CLIENT_ID", "")
    client_secret: str = os.getenv("AUTHENTIK_CLIENT_SECRET", "")
    issuer_url: str = os.getenv("AUTHENTIK_ISSUER_URL", "")

    # URLs (derived from issuer_url if not set)
    authorize_url: str = os.getenv("AUTHENTIK_AUTHORIZE_URL", "")
    token_url: str = os.getenv("AUTHENTIK_TOKEN_URL", "")
    userinfo_url: str = os.getenv("AUTHENTIK_USERINFO_URL", "")
    jwks_url: str = os.getenv("AUTHENTIK_JWKS_URL", "")
    logout_url: str = os.getenv("AUTHENTIK_LOGOUT_URL", "")

    # Application URLs
    redirect_uri: str = os.getenv("AUTHENTIK_REDIRECT_URI", "")
    post_logout_redirect_uri: str = os.getenv("AUTHENTIK_POST_LOGOUT_REDIRECT_URI", "")

    # Webhook Configuration
    webhook_secret: str = os.getenv("AUTHENTIK_WEBHOOK_SECRET", "")

    # Session Configuration
    session_cookie_name: str = "prisme_session"
    session_max_age: int = 60 * 60 * 24 * 7  # 7 days

    model_config = {"env_prefix": ""}

    def model_post_init(self, __context) -> None:
        """Derive URLs from issuer_url if not explicitly set."""
        if self.issuer_url:
            base = self.issuer_url.rstrip("/")
            # Authentik uses shared OAuth endpoints, not per-application paths
            # e.g., issuer: https://auth.example.com/application/o/myapp/
            # but authorize is at: https://auth.example.com/application/o/authorize/
            oauth_base = "/".join(base.split("/")[:-1])  # Remove app slug
            if not self.authorize_url:
                self.authorize_url = f"{oauth_base}/authorize/"
            if not self.token_url:
                self.token_url = f"{oauth_base}/token/"
            if not self.userinfo_url:
                self.userinfo_url = f"{oauth_base}/userinfo/"
            if not self.jwks_url:
                self.jwks_url = f"{oauth_base}/jwks/"
            if not self.logout_url:
                self.logout_url = f"{base}/end-session/"


@lru_cache
def get_authentik_settings() -> AuthentikSettings:
    """Get cached Authentik settings.

    Returns:
        Cached AuthentikSettings instance
    """
    return AuthentikSettings()


authentik_settings = get_authentik_settings()
