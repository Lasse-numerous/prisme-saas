# Dev Container Compose Configuration
# Workspace isolation via COMPOSE_PROJECT_NAME from .env
# All resources prefixed with ${WORKSPACE_NAME}

services:
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile.dev
    container_name: ${WORKSPACE_NAME}-app
    volumes:
      - ..:/workspace:cached
      - venv:/workspace/.venv
      - node-modules:/workspace/packages/frontend/node_modules
      - prism-claude-config:/home/vscode/.claude
    environment:
      - WORKSPACE_NAME=${WORKSPACE_NAME}
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/${DATABASE_NAME}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - default
      - prism_proxy_network
    labels:
      # Prism identification
      - "com.prism.workspace=true"
      - "com.prism.workspace.name=${WORKSPACE_NAME}"
      # Traefik routing - Frontend (port 5173)
      - "traefik.enable=true"
      - "traefik.docker.network=prism_proxy_network"
      - "traefik.http.routers.${WORKSPACE_NAME}-frontend.rule=Host(`${WORKSPACE_NAME}.localhost`)"
      - "traefik.http.routers.${WORKSPACE_NAME}-frontend.priority=1"
      - "traefik.http.services.${WORKSPACE_NAME}-frontend.loadbalancer.server.port=5173"
      # Traefik routing - API (port 8000)
      - "traefik.http.routers.${WORKSPACE_NAME}-api.rule=Host(`${WORKSPACE_NAME}.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${WORKSPACE_NAME}-api.priority=10"
      - "traefik.http.services.${WORKSPACE_NAME}-api.loadbalancer.server.port=8000"
    # Keep running for shell access
    command: sleep infinity

  db:
    image: postgres:16-alpine
    container_name: ${WORKSPACE_NAME}-db
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - default

volumes:
  venv:
    name: ${WORKSPACE_NAME}-venv
  node-modules:
    name: ${WORKSPACE_NAME}-node-modules
  pgdata:
    name: ${WORKSPACE_NAME}-pgdata
  prism-claude-config:
    name: prism-claude-config
    external: true

networks:
  prism_proxy_network:
    external: true
